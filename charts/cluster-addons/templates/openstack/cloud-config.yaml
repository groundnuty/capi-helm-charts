{{- if .Values.openstack.enabled }}
---
apiVersion: addons.cluster.x-k8s.io/v1alpha1
kind: HelmChartProxy
metadata:
  name: {{ include "cluster-addons.componentName" (list . "cloud-config") }}
  labels: {{ include "cluster-addons.componentLabels" (list . "cloud-config") | nindent 4 }}
  annotations:
    # Tell Argo to ignore the non-controller owner references for this object
    # Avoid 262144 bytes limit on annotations when embeding a long cacert chain
    argocd.argoproj.io/sync-options: "ControllerReferencesOnly=true,ServerSideApply=true"
spec:
  repoURL: {{ .Values.openstack.secret.chart.repo }}
  chartName: {{ .Values.openstack.secret.chart.name }}
  version: {{ .Values.openstack.secret.chart.version }}
  namespace: {{ .Values.openstack.targetNamespace }}
  releaseName: cloud-config
  clusterSelector:
    matchLabels:
      capi.stackhpc.com/cluster: {{ include "cluster-addons.clusterName" . }}
  valuesTemplate: |
    secretData:
    {{- with .Values.global.clouds }}
      clouds.yaml: |
        clouds:
          openstack:
            {{ index . $.Values.global.CCMCloudName | toYaml | indent 12 | trim }}
    {{- end }}
    {{- with .Values.global.cloudCACert  }}
      cacert: {{ . | toYaml | indent 6 | trim }}
    {{- end }}
      cloud.conf: |
        [Global]
        use-clouds=true
        clouds-file=/etc/config/clouds.yaml
        cloud=openstack
    {{- if .Values.global.cloudCACert }}
        ca-file=/etc/config/cacert
    {{- else }}
        tls-insecure=true
    {{- end }}
        [Networking]
        {{- $networkingItems := default dict .Values.openstack.cloudConfig.Networking }}
        {{- if hasKey $networkingItems "internal-network-name" }}
        internal-network-name={{ index $networkingItems "internal-network-name" }}
        {{- else }}
        internal-network-name={{ "{{" }} .InfraCluster.status.network.name {{ "}}" }}
        {{- end }}
        {{- range $netName, $netValue := omit $networkingItems "internal-network-name" }}
        {{ $netName }}={{ $netValue }}
        {{- end }}
        [LoadBalancer]
        {{- $lbItems := default dict .Values.openstack.cloudConfig.LoadBalancer }}
        {{- if hasKey $lbItems "floating-network-id" }}
        floating-network-id={{ index $lbItems "floating-network-id" }}
        {{- else }}
        floating-network-id={{ "{{" }} .InfraCluster.status.externalNetwork.id {{ "}}" }}
        {{- end }}
        {{- range $lbName, $lbValue := omit $lbItems "floating-network-id" }}
        {{ $lbName }}={{ $lbValue }}
        {{- end }}
        {{-
          range $section, $items := omit
            .Values.openstack.cloudConfig
            "Global"
            "LoadBalancer"
            "Networking"
        }}
        [{{ $section }}]
        {{- range $name, $value := $items }}
        {{ $name }}={{ $value }}
        {{- end }}
        {{ end }}
{{- end }}
